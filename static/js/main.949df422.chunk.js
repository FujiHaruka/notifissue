(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{151:function(e,t,n){e.exports={self:"OpenUnreadButton_self__3rPAS",help:"OpenUnreadButton_help__2ug8A"}},244:function(e,t,n){e.exports=n(428)},252:function(e,t,n){},254:function(e,t,n){},364:function(e,t,n){},423:function(e,t){},428:function(e,t,n){"use strict";n.r(t);n(245);var r=n(0),a=n.n(r),i=n(62),s=n.n(i),c=(n(252),n(25)),u=(n(254),n(433)),o=n(444),l=n(445),f=n(429),p=n(440),h=n(34),m=function(e){var t=Object(r.useState)(e),n=Object(c.a)(t,2),a=n[0],i=n[1];return[a,Object(r.useMemo)(function(){return function(e){return function(t){e("function"===typeof t?function(e){return Object(h.a)({},e,t(e))}:function(e){return Object(h.a)({},e,t)})}}(i)},[i])]},b=Object(r.createContext)(null),d=function(){return Object(r.useContext)(b)},v=function(e){var t=e.user,n=d().setModalState;return a.a.createElement(o.a,{fixed:"top",inverted:!0},a.a.createElement(u.a,null,a.a.createElement(o.a.Item,{header:!0},a.a.createElement(l.a,{as:"h3",inverted:!0},a.a.createElement(f.a,{size:"mini",src:"logo.png",style:{marginRight:"1.5em"}}),"Notifissue")),a.a.createElement(o.a.Menu,{position:"right"},a.a.createElement(o.a.Item,null,t&&a.a.createElement(p.a,{trigger:a.a.createElement("span",{style:{color:"white"}},a.a.createElement(f.a,{avatar:!0,src:t.avatar_url}),t.name)},a.a.createElement(p.a.Menu,null,a.a.createElement(p.a.Header,{content:"Signed in by GitHub"}),a.a.createElement(p.a.Item,{text:"Unregister token",icon:"sign out",onClick:function(){return n({unregistrationModal:!0})}})))))))},k=n(441),g=n(93),w=n(127),y=n(55),x=n(220),O=n.n(x),j=n(123),E=function(e){return function(t){return Object.entries(t).map(function(t){var n=Object(c.a)(t,2),r=n[0],a=n[1];return[e(r),a]}).reduce(function(e,t){var n=Object(c.a)(t,2),r=n[0],a=n[1];return Object(h.a)({},e,Object(y.a)({},r,a))},{})}},N=function(e){return new Promise(function(t){return setTimeout(t,e)})},T=function(e,t){var n=this[e];return n instanceof Date?{$type:"Date",$value:n.getTime()}:t},A=function(e,t){return t&&"Date"===t.$type?new Date(t.$value):t},C=function(e){return JSON.stringify(e,T)},R=function(e){return JSON.parse(e,A)},I="https://github.com",S={pullRequestApi:new j.a("/repos/:owner/:repo/pulls/:number"),pullRequestHtml:new j.a("/:owner/:repo/pull/:number"),issueApi:new j.a("/repos/:owner/:repo/issues/:number"),issueHtml:new j.a("/:owner/:repo/issues/:number")},_=function(e){var t=e.subject,n=t.type,r=t.url,a=new URL(r).pathname,i=e.repository.html_url;switch(n){case"PullRequest":var s=S.pullRequestApi.test(a);return s?I+S.pullRequestHtml.build(s):(console.error('Something wrong on finding HTML URL. Type is "PullRequest", but given URL is '.concat(r)),i);case"Issue":var c=S.issueApi.test(a);return c?I+S.issueHtml.build(c):(console.error('Something wrong on finding HTML URL. Type is "Issue", but given URL is '.concat(r)),i);default:return i}},M=(n(364),function(e){return a.a.createElement("span",{className:"NotificationListItem-desc-item"},e.children)}),U=function(e){var t,n=d().setModalState,i=e.notification,s=i.subject,c=i.updated_at,u=i.unread,o=i.repository,l=i.reason,f=s.title,p=s.type,h=_(i),m=Object(r.useCallback)(function(e){e.preventDefault(),n({commentModal:!0,commentModalParams:{notification:i}})},[]);return a.a.createElement(k.a.Item,{className:"NotificationListItem",as:"a",target:"_blank",href:h},a.a.createElement(k.a.Content,{floated:"right"},a.a.createElement(g.a,{tag:!0},p,a.a.createElement(g.a.Detail,null,l))),a.a.createElement(k.a.Icon,{name:u?"circle outline":"check circle outline",verticalAlign:"top"}),a.a.createElement(k.a.Content,null,a.a.createElement(k.a.Header,null,f,function(e){return Boolean(e.subject.latest_comment_url)}(i)&&a.a.createElement(w.a,{name:"comment alternate outline",color:"blue",className:"NotificationListItem-comment",title:"View latest comment now",onClick:m})),a.a.createElement(k.a.Description,{className:"NotificationListItem-desc"},a.a.createElement(M,null,o.full_name),a.a.createElement(M,null,"At ",(t=c,O()(t).format("YYYY/MM/DD HH:mm"))))))},L=function(e){var t=e.notifications;return"unread"===e.filter&&(t=t.filter(function(e){return e.unread})),a.a.createElement(k.a,{divided:!0,verticalAlign:"middle",relaxed:"very",selection:!0,className:"NotificationList"},t.map(function(e){return a.a.createElement(U,{key:e.id,notification:e})}))},H=n(6),D=n.n(H),P=n(9),G=n(448),K=n(434),B=n(443),W=function(e){var t=Object(r.useState)(""),n=Object(c.a)(t,2),i=n[0],s=n[1],u=Object(r.useState)(!1),o=Object(c.a)(u,2),p=o[0],h=o[1],m=Object(r.useState)(!1),b=Object(c.a)(m,2),d=b[0],v=b[1],k=Object(r.useCallback)(function(){var t=Object(P.a)(D.a.mark(function t(n){return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return v(!1),t.next=3,e.onRegister(n);case 3:t.sent||v(!0);case 5:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),[]);return a.a.createElement(a.a.Fragment,null,a.a.createElement(l.a,{as:"h1",icon:!0,textAlign:"center"},a.a.createElement(f.a,{size:"massive",src:"logo.png"}),a.a.createElement(l.a.Content,null,"Notifissue"),a.a.createElement(l.a.Subheader,null,"GitHub notification timeline with web notification")),a.a.createElement(G.a,{className:"Welcome-segment",basic:!0,textAlign:"center"},"Nottisue let you know GitHub notifications by web notification. All you need to do is to register your GitHub access token. It will be saved in local storage. Then, you get GitHub notifications through your browser."),a.a.createElement(G.a,{className:"Welcome-segment",basic:!0,textAlign:"center"},a.a.createElement(l.a,{as:"h3"},"Get started"),d&&a.a.createElement("span",{className:"Welcome-input-error"},"Invalid access token."),a.a.createElement(K.a,{action:a.a.createElement(B.a,{primary:!0,loading:p,onClick:function(){var e=Object(P.a)(D.a.mark(function e(t){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i){e.next=2;break}return e.abrupt("return");case 2:return h(!0),e.next=5,k(i);case 5:h(!1);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},"Save"),placeholder:"GitHub Access Token",onChange:function(e,t){var n=t.value;s(n)},error:d})))},q=function(e){var t=function(t,n){var r=n.name;return e.onChange(r)};return a.a.createElement(G.a,{basic:!0,textAlign:"center"},a.a.createElement(o.a,{compact:!0,color:"blue"},a.a.createElement(o.a.Item,{name:"unread",active:"unread"===e.filter,onClick:t,content:"UNREAD"}),a.a.createElement(o.a.Item,{name:"all",active:"all"===e.filter,onClick:t,content:"ALL"})))},F=n(439),Y=n(151),J=n.n(Y),$=function(e,t){return new Date(e.updated_at).getTime()-new Date(e.updated_at).getTime()},z=function(e){var t=e.notifications.filter(function(e){return e.unread}).sort($),n=Object(r.useState)(!1),i=Object(c.a)(n,2),s=i[0],u=i[1],o=function(){var e=Object(P.a)(D.a.mark(function e(){var n,r,a,i,s,c,o;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:u(!0),n=!0,r=!1,a=void 0,e.prev=4,i=t[Symbol.iterator]();case 6:if(n=(s=i.next()).done){e.next=15;break}return c=s.value,o=_(c),window.open(o),e.next=12,N(2e3);case 12:n=!0,e.next=6;break;case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(4),r=!0,a=e.t0;case 21:e.prev=21,e.prev=22,n||null==i.return||i.return();case 24:if(e.prev=24,!r){e.next=27;break}throw a;case 27:return e.finish(24);case 28:return e.finish(21);case 29:u(!1);case 30:case"end":return e.stop()}},e,this,[[4,17,21,29],[22,,24,28]])}));return function(){return e.apply(this,arguments)}}();return a.a.createElement("span",{className:J.a.self},a.a.createElement(B.a,{basic:!0,color:"black",loading:s,disabled:s,onClick:o,content:"OPEN ALL UNREAD"}),a.a.createElement(F.a,{trigger:a.a.createElement(B.a,{circular:!0,size:"tiny",className:J.a.help,icon:"help"})},a.a.createElement(F.a.Header,null,"OPEN ALL UNREAD button"),a.a.createElement(F.a.Content,null,a.a.createElement("p",null,'Allow browser pop-up feature to use the "OPEN ALL UNREAD" button.'))))},V=function(e){var t=d(),n=t.unregistrationModal,i=t.setModalState,s=Object(r.useCallback)(function(){return i({unregistrationModal:!1})},[]),c=Object(r.useCallback)(function(){e.onUnregister(),s()},[]);return a.a.createElement(F.a,{size:"mini",open:n,onClose:s},a.a.createElement(F.a.Header,null,"Delete Your Access Token"),a.a.createElement(F.a.Content,null,"Are you sure?"),a.a.createElement(F.a.Actions,null,a.a.createElement(B.a,{negative:!0,content:"No",onClick:s}),a.a.createElement(B.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Yes",onClick:c})))},Q=n(446),X=n(436),Z=n(442),ee=n(229),te=n.n(ee),ne=n(94),re=n.n(ne),ae=n(74),ie=n(28),se=n(29),ce=(n(423),n(230)),ue=n.n(ce),oe=n(437),le=n(435),fe=Object(oe.a)(function(e){return e.id}),pe=Object(le.a)(function(e,t){return new Date(t.updated_at).getTime()-new Date(e.updated_at).getTime()}),he=function(){function e(){Object(ie.a)(this,e),this.storage=window.localStorage,this.maxNotifications=500,this.notificationKey="github:notification:items",this.metaKey="github:notification:meta",this.tokenKey="github:token",this.userKey="github:user",this.bNotifiedKey="browser:notified"}return Object(se.a)(e,[{key:"drop",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.clear();case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.storage.getItem(this.notificationKey)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.abrupt("return",R(t));case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"saveNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getNotifications();case 2:n=e.sent,r=fe([].concat(Object(ae.a)(t),Object(ae.a)(n))),a=pe(r),this.storage.setItem(this.notificationKey,C(a));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"cleanUpOldNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t,n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getNotifications();case 2:if(!((t=e.sent).length<=this.maxNotifications)){e.next=5;break}return e.abrupt("return");case 5:n=t.slice(0,this.maxNotifications),this.storage.setItem(this.notificationKey,C(n));case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getNotificationMeta",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.storage.getItem(this.metaKey)){e.next=3;break}return e.abrupt("return",null);case 3:return e.abrupt("return",R(t));case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"saveNotificationMeta",value:function(){var e=Object(P.a)(D.a.mark(function e(t){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.setItem(this.metaKey,C(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getBNotified",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.storage.getItem(this.bNotifiedKey)){e.next=3;break}return e.abrupt("return",{});case 3:return e.abrupt("return",R(t));case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"saveBNotified",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getBNotified();case 2:n=e.sent,r=Object(h.a)({},n,t),this.storage.setItem(this.bNotifiedKey,C(r));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"saveAccessToken",value:function(){var e=Object(P.a)(D.a.mark(function e(t){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.setItem(this.tokenKey,t);case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getAccessToken",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storage.getItem(this.tokenKey));case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"clearAccessToken",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.removeItem(this.tokenKey);case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"saveUser",value:function(){var e=Object(P.a)(D.a.mark(function e(t){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.setItem(this.userKey,C(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"getUser",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.storage.getItem(this.userKey)){e.next=3;break}return e.abrupt("return",null);case 3:return e.abrupt("return",R(t));case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"clearUser",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.storage.removeItem(this.userKey);case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}(),me=n(231),be=n(232),de=n.n(be),ve=n(233),ke=n(438),ge="https://api.github.com/notifications",we="https://api.github.com/user",ye=E(ve.snake),xe=E(function(e){return e instanceof Date?e.toISOString():"boolean"===typeof e?e?"true":"false":e}),Oe=Object(ke.a)(ye,xe,function(e){return de.a.stringify(e,{format:"RFC1738"})}),je=function(){function e(t){Object(ie.a)(this,e),this.accessToken=void 0,this.accessToken=t.accessToken}return Object(se.a)(e,[{key:"fetchNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a,i,s,u,o,l,f,p,m,b,d,v,k,g;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=ge+"?"+Oe(Object(h.a)({accessToken:this.accessToken},t)),e.next=3,fetch(n);case 3:return r=e.sent,e.next=6,r.json();case 6:a=e.sent,i={},s=!0,u=!1,e.prev=10,l=Object(me.a)(r.headers.entries());case 12:return e.next=14,l.next();case 14:return f=e.sent,s=f.done,e.next=18,f.value;case 18:if(p=e.sent,s){e.next=25;break}m=p,b=Object(c.a)(m,2),d=b[0],v=b[1],i[d.toLowerCase()]=v;case 22:s=!0,e.next=12;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(10),u=!0,o=e.t0;case 31:if(e.prev=31,e.prev=32,s||null==l.return){e.next=36;break}return e.next=36,l.return();case 36:if(e.prev=36,!u){e.next=39;break}throw o;case 39:return e.finish(36);case 40:return e.finish(31);case 41:if(k=i,g={lastModified:new Date(k["last-modified"]),lastFetched:new Date,pollInterval:Number(k["x-poll-interval"])},r.ok){e.next=47;break}if(304!==r.status){e.next=46;break}return e.abrupt("return",{meta:g,notifications:[]});case 46:throw new Error(a.message);case 47:return e.abrupt("return",{meta:g,notifications:a});case 48:case"end":return e.stop()}},e,this,[[10,27,31,41],[32,,36,40]])}));return function(t){return e.apply(this,arguments)}}()},{key:"fetchAuthenticatedUser",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t,n,r;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=we+"?"+Oe({accessToken:this.accessToken}),e.next=3,fetch(t);case 3:if((n=e.sent).ok){e.next=7;break}return console.error("Failed to fetch user: ".concat(n.status," ").concat(n.statusText)),e.abrupt("return",null);case 7:return e.next=9,n.json();case 9:return r=e.sent,e.abrupt("return",r);case 11:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"fetchComment",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t+"?"+Oe({accessToken:this.accessToken}),e.next=3,fetch(n);case 3:if((r=e.sent).ok){e.next=7;break}return console.error("Failed to fetch comment ".concat(r.status," ").concat(r.statusText)),e.abrupt("return",null);case 7:return e.next=9,r.json();case 9:return a=e.sent,e.abrupt("return",a);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"markThreadAsRead",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t+"?"+Oe({accessToken:this.accessToken}),e.next=3,fetch(n,{method:"PATCH"});case 3:if((r=e.sent).ok){e.next=7;break}return console.error("Failed to mark a thread as read ".concat(r.status," ").concat(r.statusText)),e.abrupt("return",!1);case 7:return e.abrupt("return",!0);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),Ee=function(){function e(t){Object(ie.a)(this,e),this.task=void 0,this.timer=-1,this.minTimeout=3e4,this.running=!1,this.task=t}return Object(se.a)(e,[{key:"startRunning",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.running){e.next=2;break}return e.abrupt("return");case 2:return this.running=!0,e.next=5,this.doTask();case 5:t=e.sent,this.setNextTimeout(t);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"stopRunning",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.running=!1,clearTimeout(this.timer);case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"doTask",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[TaskScheduler] do task"),t=this.minTimeout,e.prev=2,e.next=5,this.task();case 5:t=e.sent,e.next=11;break;case 8:e.prev=8,e.t0=e.catch(2),console.error(e.t0);case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this,[[2,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"setNextTimeout",value:function(e){var t=this;clearTimeout(this.timer),this.timer=window.setTimeout(Object(P.a)(D.a.mark(function e(){var n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.running){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,t.doTask();case 4:n=e.sent,t.setNextTimeout(n);case 6:case"end":return e.stop()}},e,this)})),e),console.log("[TaskScheduler] set next time after ".concat(e," ms"))}}]),e}(),Ne=function(){function e(){var t=this;Object(ie.a)(this,e),this.db=new he,this.api=new je({accessToken:""}),this.subscriptions=new Map,this.user=null,this.scheduler=void 0,this.running=!1,this.ready=!1,this.notificationsSyncTask=Object(P.a)(D.a.mark(function e(){var n,r,a,i;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.api.fetchNotifications({all:!0});case 2:return n=e.sent,r=n.meta,a=n.notifications,e.next=7,t.db.saveNotifications(a);case 7:return e.next=9,t.db.saveNotificationMeta(r);case 9:return i=Math.max(r.lastFetched.getTime()+1e3*r.pollInterval-(new Date).getTime(),0),e.next=12,t.publishToSubscriptions();case 12:return e.abrupt("return",i);case 13:case"end":return e.stop()}},e,this)})),this.scheduler=new Ee(this.notificationsSyncTask)}return Object(se.a)(e,[{key:"prepare",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t,n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.ready){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.db.getAccessToken();case 4:return t=e.sent,e.next=7,this.db.getUser();case 7:if(n=e.sent,t&&n){e.next=11;break}return this.ready=!0,e.abrupt("return");case 11:this.api.accessToken=t,this.user=n,this.ready=!0;case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"subscribe",value:function(e,t){if(!this.running)throw new Error("[GitHubServer] Cannot subscribe when not running");var n={id:ue()(),observe:e,options:t};return this.subscriptions.set(n.id,n),this.publishTo(n),n}},{key:"unsubscribe",value:function(){this.subscriptions.clear()}},{key:"publishTo",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db.getUser();case 2:return n=e.sent,e.next=5,this.db.getNotificationMeta();case 5:return r=e.sent,e.next=8,this.db.getNotifications();case 8:if(a=e.sent,n&&r){e.next=11;break}return e.abrupt("return");case 11:t.observe({user:n,meta:r,notifications:a});case 12:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"publishToSubscriptions",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t,n,r;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=Array.from(this.subscriptions.values()),n=0;case 2:if(!(n<t.length)){e.next=9;break}return r=t[n],e.next=6,this.publishTo(r);case 6:n++,e.next=2;break;case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"startRunning",value:function(){if(!this.user)throw new Error("[GitHubServer] Cannot run without user");if(this.running)throw new Error("[GitHubServer] Already running");console.log("[GitHubServer] start running"),this.running=!0,this.scheduler.startRunning()}},{key:"stopRunning",value:function(){console.log("[GitHubServer] stop running"),this.running=!1,this.scheduler.stopRunning()}},{key:"canRun",value:function(){return Boolean(this.user)&&!this.running}},{key:"register",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.api.accessToken=t,e.next=3,this.api.fetchAuthenticatedUser();case 3:if(n=e.sent){e.next=7;break}return this.api.accessToken="",e.abrupt("return",null);case 7:return e.next=9,this.db.saveUser(n);case 9:return e.next=11,this.db.saveAccessToken(t);case 11:return this.user=n,e.abrupt("return",n);case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"unregister",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db.drop();case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"fetchLatestComment",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.subject.latest_comment_url){e.next=4;break}return console.error("[GitHubServer] no latest_comment_url in subject"),e.abrupt("return",null);case 4:return e.abrupt("return",this.api.fetchComment(n));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"markAsRead",value:function(){var e=Object(P.a)(D.a.mark(function e(t){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.api.markThreadAsRead(t.url));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}],[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),e}();Ne.instance=void 0;var Te=function(e,t){var n=m({ready:!1,busy:!1,result:t,error:null}),a=Object(c.a)(n,2),i=a[0],s=i.ready,u=i.busy,o=i.result,l=i.error,f=a[1],p=Object(r.useMemo)(function(){return function(e,t,n,r){return function(){var a=Object(P.a)(D.a.mark(function a(i,s){var c,u,o,l,f,p;return D.a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(u=(c=s||{}).force,o=void 0!==u&&u,l=c.allowParallel,f=void 0!==l&&l,!n||o){a.next=3;break}return a.abrupt("return");case 3:if(!r||f){a.next=5;break}return a.abrupt("return");case 5:return t({busy:!0}),a.prev=6,a.next=9,e(i);case 9:p=a.sent,t({result:p,ready:!0,busy:!1}),a.next=17;break;case 13:a.prev=13,a.t0=a.catch(6),console.error(a.t0),t({error:a.t0,busy:!1});case 17:case"end":return a.stop()}},a,this,[[6,13]])}));return function(e,t){return a.apply(this,arguments)}}()}(e,f,s,u)},[e,s,u]),h=Object(r.useCallback)(function(){return f({ready:!1,busy:!1,result:t,error:null})},[t]);return{ready:s,busy:u,result:o,error:l,reset:h,doAsync:p}},Ae=function(e){var t=e.onMount,n=e.onUnmount;Object(r.useEffect)(function(){return t(),function(){n()}},[])},Ce=function(){function e(){Object(ie.a)(this,e),this.isGranted=!1,this.lifetime=1e4}return Object(se.a)(e,[{key:"spawnNotification",value:function(e){if(this.isGranted){var t=e.title,n=e.body,r=new Notification(t,{body:n,icon:"./logo.png"});setTimeout(r.close.bind(r),this.lifetime)}else console.warn("Cannot spawn notification for not granted")}},{key:"requestPermissionIfNeeded",value:function(){var e=Object(P.a)(D.a.mark(function e(){var t=this;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("Notification"in window){e.next=2;break}return e.abrupt("return");case 2:if("granted"!==Notification.permission){e.next=5;break}return this.isGranted=!0,e.abrupt("return");case 5:return e.abrupt("return",new Promise(function(e){Notification.requestPermission(function(n){t.isGranted="granted"===n,e()})}));case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}(),Re=["assign","author","comment","invitation","manual","mention","state_change","subscribed","team_mention"],Ie=function(){function e(t){Object(ie.a)(this,e),this.db=new he,this.reasons=void 0,this.bNotification=new Ce,this.reasons=t.reasons||Re}return Object(se.a)(e,[{key:"onNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a,i,s,c,u;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.validate();case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,this.filterNewNotifications(t);case 7:(n=e.sent).length>0&&console.log("[NotificationNotifier] ".concat(n.length," new notifications")),r=!0,a=!1,i=void 0,e.prev=12,s=n[Symbol.iterator]();case 14:if(r=(c=s.next()).done){e.next=23;break}return u=c.value,e.next=18,this.spawnBrowserNotification(u);case 18:return e.next=20,N(3e3);case 20:r=!0,e.next=14;break;case 23:e.next=29;break;case 25:e.prev=25,e.t0=e.catch(12),a=!0,i=e.t0;case 29:e.prev=29,e.prev=30,r||null==s.return||s.return();case 32:if(e.prev=32,!a){e.next=35;break}throw i;case 35:return e.finish(32);case 36:return e.finish(29);case 37:case"end":return e.stop()}},e,this,[[12,25,29,37],[30,,32,36]])}));return function(t){return e.apply(this,arguments)}}()},{key:"validate",value:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("Notification"in window){e.next=2;break}return e.abrupt("return",!1);case 2:return e.next=4,this.bNotification.requestPermissionIfNeeded();case 4:if(this.bNotification.isGranted){e.next=6;break}return e.abrupt("return",!1);case 6:return e.abrupt("return",!0);case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"filterNewNotifications",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a=this;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.db.getBNotified();case 2:return n=e.sent,r=t.filter(function(e){return e.unread}).filter(function(e){var t=e.reason;return a.reasons.includes(t)}).filter(function(e){var t=e.id,r=e.updated_at;return!n[t]||n[t].getTime()<new Date(r).getTime()}),e.abrupt("return",r);case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"spawnBrowserNotification",value:function(){var e=Object(P.a)(D.a.mark(function e(t){var n,r,a;return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.id,r=t.subject,a=t.updated_at,e.next=3,this.db.saveBNotified(Object(y.a)({},n,new Date(a)));case 3:this.bNotification.spawnNotification({title:r.type,body:r.title});case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();Ie.instance=null,Ie.getInstance=function(){return Ie.instance||(Ie.instance=new Ie({})),Ie.instance};var Se=Object(r.createContext)(null),_e=function(){return Object(r.useContext)(Se)},Me=function(e){var t=e.notification;return a.a.createElement("a",{className:re.a.reposLink,href:_(t),target:"_blank"},t.repository.full_name,"#",t.subject.url.split("/").pop())},Ue=function(){var e=d(),t=e.commentModal,n=e.commentModalParams,i=e.setModalState,s=function(){var e=Ne.getInstance(),t=_e(),n=t.notifications,r=t.setObserved;return{fetchLatestComment:Te(function(t){return e.fetchLatestComment(t)},null),markAsRead:Te(function(){var t=Object(P.a)(D.a.mark(function t(a){var i,s;return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.markAsRead(a);case 2:if(t.sent){t.next=5;break}return t.abrupt("return",!1);case 5:if(!((i=n.findIndex(function(e){var t=e.id;return a.id===t}))<0)){t.next=8;break}return t.abrupt("return",!1);case 8:return(s=Object(ae.a)(n))[i]=Object(h.a)({},a,{unread:!1}),r({notifications:s}),t.abrupt("return",!0);case 12:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),!1)}}(),c=s.fetchLatestComment,u=s.markAsRead,o=t&&n.notification;Object(r.useEffect)(function(){o&&c.doAsync(n.notification,{force:!0})},[o]);var l=Object(r.useCallback)(function(){i({commentModal:!1,commentModalParams:{}}),c.reset(),u.reset()},[]),f=c.result&&c.result.body;if(!o)return null;var p=n.notification;return a.a.createElement(F.a,{open:t,onClose:l},a.a.createElement(F.a.Header,{className:re.a.header},a.a.createElement(Me,{notification:p}),"Latest comment by"," ",a.a.createElement("span",{className:re.a.user},"@",c.result&&c.result.user.login)),a.a.createElement(F.a.Content,null,a.a.createElement(Q.a,{active:c.busy,inverted:!0},a.a.createElement(X.a,{inverted:!0})),c.ready&&f&&a.a.createElement("div",{dangerouslySetInnerHTML:{__html:te()(f)}}),c.ready&&!f&&a.a.createElement("div",{className:re.a.alt},"No comment body"),c.error&&a.a.createElement(Z.a,{negative:!0,header:"Error",content:c.error.message})),a.a.createElement(F.a.Actions,null,a.a.createElement(B.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Mark as read",loading:u.busy,onClick:function(){console.log("onclick",p),u.doAsync(p).then(function(){return l()})}})))},Le=function(e){var t=e.onUnregister;return a.a.createElement(a.a.Fragment,null,a.a.createElement(V,{onUnregister:t}),a.a.createElement(Ue,null))},He=function(){var e=_e(),t=e.ready,n=e.userRegistered,i=e.user,s=e.notifications,o=(e.meta,e.registerUser),l=e.unregisterUser,f=Object(r.useState)("unread"),p=Object(c.a)(f,2),h=p[0],m=p[1];return t?a.a.createElement("div",{className:"App"},a.a.createElement(v,{user:i}),a.a.createElement(u.a,{text:!0,style:{paddingTop:"5em",marginBottom:"2em"}},n&&a.a.createElement(a.a.Fragment,null,a.a.createElement(q,{filter:h,onChange:m}),a.a.createElement("div",{className:"App-OpenUnreadButton"},a.a.createElement(z,{notifications:s})),a.a.createElement(L,{notifications:s,filter:h})),!n&&a.a.createElement(W,{onRegister:o})),a.a.createElement(Le,{onUnregister:l})):null},De=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function Pe(e,t){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var n=e.installing;null!=n&&(n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See http://bit.ly/CRA-PWA."),t&&t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t&&t.onSuccess&&t.onSuccess(e)))})}}).catch(function(e){console.error("Error during service worker registration:",e)})}s.a.render(a.a.createElement(function(e){var t=function(){var e=m({unregistrationModal:!1,commentModal:!1,commentModalParams:{}}),t=Object(c.a)(e,2),n=t[0],r=t[1];return Object(h.a)({},n,{setModalState:r})}();return a.a.createElement(b.Provider,{value:t},e.children)},null,a.a.createElement(function(e){var t=function(){var e=Ne.getInstance(),t=m({ready:!1,userRegistered:!1}),n=Object(c.a)(t,2),a=n[0],i=a.ready,s=a.userRegistered,u=n[1],o=m({user:null,notifications:[],meta:null}),l=Object(c.a)(o,2),f=l[0],p=f.user,h=f.notifications,b=f.meta,d=l[1],v=Object(r.useCallback)(function(){e.startRunning(),e.subscribe(function(e){d(e),Ie.getInstance().onNotifications(e.notifications)},{})},[]),k=Object(r.useCallback)(function(){e.unsubscribe(),e.stopRunning()},[]),g=Object(r.useCallback)(function(){var t=Object(P.a)(D.a.mark(function t(n){var r;return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.register(n);case 2:if(r=t.sent,u({userRegistered:Boolean(r)}),r){t.next=6;break}return t.abrupt("return",null);case 6:return v(),t.abrupt("return",r);case 8:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),[]),w=Object(r.useCallback)(Object(P.a)(D.a.mark(function t(){return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return k(),t.next=3,e.unregister();case 3:u({userRegistered:!1}),d({user:null,notifications:[],meta:null});case 5:case"end":return t.stop()}},t,this)})),[]);return Ae({onMount:function(){var t=Object(P.a)(D.a.mark(function t(){var n;return D.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.prepare();case 2:(n=e.canRun())&&v(),u({ready:!0,userRegistered:n});case 5:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}(),onUnmount:function(){var e=Object(P.a)(D.a.mark(function e(){return D.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:k();case 1:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}),{ready:i,userRegistered:s,user:p,notifications:h,meta:b,setObserved:d,registerUser:g,unregisterUser:w}}();return a.a.createElement(Se.Provider,{value:t},e.children)},null,a.a.createElement(He,null))),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/notifissue",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",function(){var t="".concat("/notifissue","/service-worker.js");De?(function(e,t){fetch(e).then(function(n){var r=n.headers.get("content-type");404===n.status||null!=r&&-1===r.indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):Pe(e,t)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(t,e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit http://bit.ly/CRA-PWA")})):Pe(t,e)})}}()},94:function(e,t,n){e.exports={header:"CommentModal_header__2J5EE",alt:"CommentModal_alt__1VVRI",reposLink:"CommentModal_reposLink__r9SC2",user:"CommentModal_user__38fQS"}}},[[244,2,1]]]);
//# sourceMappingURL=main.949df422.chunk.js.map